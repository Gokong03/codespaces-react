<!DOCTYPE html>
<html lang="id" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Kasir Multi Saldo</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <header class="header">
        <button class="icon-button" id="btnMenu">‚ò∞</button>
        <h1 id="headerTitle"></h1>
        <div id="logoBox"></div>
    </header>

    <div id="drawer">
        <div class="drawer-header">
            <div class="shop-profile">
                <img id="logoSide" alt="logo" style="display:none;">
                <div>
                    <div id="shopNameSide"></div>
                    <div id="shopAddrSide" class="sub"></div>
                </div>
            </div>
            <button id="closeDrawer" class="icon-button">√ó</button>
        </div>
        <div class="menu">
            <a href="#" data-go="profil">Profil Toko</a>
            <a href="#" data-go="user">Pengaturan User</a>
            <a href="#" data-go="akun">Pengaturan Akun</a>
            <hr>
            <a href="#" data-go="history">History Transaksi</a>
            <a href="#" data-go="rekap">Rekapitulasi</a>
        </div>
    </div>
    <div id="mask"></div>

    <main>
        <section id="page-profil" class="page hidden">
            <h2>Profil Toko</h2>
            <div class="card">
                <div class="form-group">
                    <label for="pName">Nama Toko</label>
                    <input type="text" id="pName" placeholder="Nama Toko / Usaha">
                </div>
                <div class="form-group">
                    <label for="pWa">Nomor WhatsApp</label>
                    <input type="tel" id="pWa" placeholder="e.g. 08123456789">
                </div>
                <div class="form-group">
                    <label for="pAddr">Alamat</label>
                    <textarea id="pAddr" rows="2" placeholder="Alamat singkat"></textarea>
                </div>
                <div class="form-group">
                    <label for="pLogo">Logo (Max 1MB)</label>
                    <input type="file" id="pLogo" accept="image/*">
                </div>
                <div class="btn-group">
                    <button id="pSave" class="btn">Simpan Profil</button>
                    <button id="pClear" class="btn-subtle">Hapus Profil</button>
                </div>
            </div>
        </section>

        <section id="page-user" class="page hidden">
            <h2>Pengaturan User</h2>
            <div class="card">
                <h3>Tampilan</h3>
                <div class="form-group">
                    <label for="uTheme">Theme</label>
                    <select id="uTheme">
                        <option value="auto">Auto</option>
                        <option value="light">Light</option>
                        <option value="dark">Dark</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="uFont">Ukuran Font (px)</label>
                    <input type="number" id="uFont" value="15" min="10" max="20">
                </div>
                <div class="btn-group">
                    <button id="uSave" class="btn">Simpan Tampilan</button>
                </div>
            </div>
            <div class="card">
                <h3>Background</h3>
                <div class="form-group">
                    <label for="bgFile">Ganti Background (Max 2MB)</label>
                    <input type="file" id="bgFile" accept="image/*">
                </div>
                <div class="btn-group">
                    <button id="bgSave" class="btn">Simpan Background</button>
                    <button id="bgClear" class="btn-subtle">Hapus Background</button>
                </div>
            </div>
        </section>

        <section id="page-stok" class="page hidden">
            <h2>Pengaturan Stok</h2>
            <div class="card">
                <div class="form-grid">
                    <input type="text" id="tKode" placeholder="Kode Barang">
                    <input type="text" id="tNama" placeholder="Nama Barang">
                    <input type="number" id="tBeli" placeholder="Harga Beli">
                    <input type="number" id="tJual" placeholder="Harga Jual">
                    <input type="number" id="tQty" placeholder="Stok Awal / Tambah">
                </div>
                <div class="btn-group">
                    <button id="tAdd" class="btn">Simpan Barang</button>
                    <button id="tDel" class="btn-subtle">Hapus Barang</button>
                </div>
            </div>
            <div class="card">
                <h3>Daftar Stok</h3>
                <div id="tList"></div>
            </div>
        </section>

        <section id="page-fisik" class="page">
            <h2>Transaksi Fisik</h2>
            <div class="card">
                <div class="form-group">
                    <label for="fKode">Kode Barang</label>
                    <div class="input-group">
                        <input type="text" id="fKode" list="listBarang" placeholder="Ketik kode lalu Enter">
                        <button id="fBtnAuto" class="btn-subtle">üîç</button>
                        <datalist id="listBarang"></datalist>
                    </div>
                </div>
                <div class="form-grid-2">
                    <input type="text" id="fNama" placeholder="Nama Barang" readonly>
                    <input type="number" id="fBeli" placeholder="Harga Beli" readonly>
                </div>
                <div class="form-grid-3">
                    <div class="form-group">
                        <label for="fJual">Harga Jual</label>
                        <input type="number" id="fJual" placeholder="Harga Jual">
                    </div>
                    <div class="form-group">
                        <label for="fQty">Qty</label>
                        <input type="number" id="fQty" value="1">
                    </div>
                    <div class="form-group">
                        <label for="fJenis">Jenis</label>
                        <select id="fJenis">
                            <option value="jual">Jual</option>
                            <option value="beli">Beli</option>
                            <option value="retur-jual">Retur Jual</option>
                            <option value="retur-beli">Retur Beli</option>
                        </select>
                    </div>
                </div>
                <div class="stat-group">
                    <div>Modal: <span id="fModal"></span></div>
                    <div>Omzet: <span id="fOmzet"></span></div>
                    <div>Laba: <span id="fLaba"></span></div>
                </div>
                <hr>
                <div class="form-grid-2">
                    <div class="form-group">
                        <label for="fAkun">Akun Saldo</label>
                        <select id="fAkun"></select>
                    </div>
                     <div class="form-group">
                        <label for="fDate">Tanggal</label>
                        <input type="date" id="fDate">
                    </div>
                </div>
                <div class="btn-group">
                    <button id="fSave" class="btn">Simpan Transaksi</button>
                    <button id="fClear" class="btn-subtle">Clear</button>
                </div>
            </div>
        </section>

        <section id="page-digital" class="page hidden">
            <h2>Transaksi Digital</h2>
            <div class="card">
                <div class="form-grid-2">
                    <div class="form-group">
                        <label for="dJenis">Jenis Transaksi</label>
                        <select id="dJenis">
                            <option value="jual">Jual Produk Digital</option>
                            <option value="beli">Beli Stok Digital</option>
                            <option value="tarik">Tarik Saldo</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="dDesc">Deskripsi</label>
                        <input type="text" id="dDesc" placeholder="e.g. Pulsa, Listrik, GoPay">
                    </div>
                </div>

                <div id="dModeJualBeli">
                    <div class="form-grid-2">
                        <div class="form-group">
                            <label for="dBeli">Harga Beli / Modal</label>
                            <input type="number" id="dBeli" value="0">
                        </div>
                        <div class="form-group">
                            <label for="dJual">Harga Jual</label>
                            <input type="number" id="dJual" value="0">
                        </div>
                    </div>
                    <div class="stat-group">Laba: <span id="dLaba"></span></div>
                </div>

                <div id="dModeTarik" class="hidden">
                     <div class="form-grid-2">
                        <div class="form-group">
                            <label for="dPokok">Jumlah Pokok</label>
                            <input type="number" id="dPokok" value="0">
                        </div>
                        <div class="form-group">
                            <label for="dFee">Fee / Laba</label>
                            <input type="number" id="dFee" value="0">
                        </div>
                    </div>
                </div>
                <hr>
                <div class="form-grid-2">
                    <div class="form-group">
                        <label for="dAkun">Akun Saldo</label>
                        <select id="dAkun"></select>
                    </div>
                     <div class="form-group">
                        <label for="dDate">Tanggal</label>
                        <input type="date" id="dDate">
                    </div>
                </div>
                <div class="btn-group">
                    <button id="dSave" class="btn">Simpan Transaksi</button>
                    <button id="dClear" class="btn-subtle">Clear</button>
                </div>
            </div>
        </section>

        <section id="page-history" class="page hidden">
            <h2>History Transaksi</h2>
            <div class="card">
                <div class="filter-bar">
                    <select id="hScope">
                        <option value="month">Bulanan</option>
                        <option value="day">Harian</option>
                        <option value="custom">Custom</option>
                    </select>
                    <input type="date" id="hFrom">
                    <input type="date" id="hTo">
                    <select id="hAkun"></select>
                    <input type="search" id="hSearch" placeholder="Cari...">
                    <button id="hClear" class="btn-subtle">Clear</button>
                </div>
                <div id="hResult" class="trx-list"></div>
            </div>
        </section>

        <section id="page-rekap" class="page hidden">
            <h2>Rekapitulasi</h2>
            <div class="card">
                 <div class="filter-bar">
                    <div id="rkSeg" class="segmented-control">
                        <button data-mode="harian" class="on">Harian</button>
                        <button data-mode="bulanan">Bulanan</button>
                    </div>
                    <input type="date" id="rDate">
                    <select id="rAkun"></select>
                </div>
                <h3 id="rkTitle"></h3>
                <div id="rkBody"></div>
            </div>
        </section>

        <section id="page-akun" class="page hidden">
            <h2>Pengaturan Akun</h2>
            <div class="card">
                <div class="form-grid-3">
                    <input type="text" id="paName" placeholder="Nama Akun">
                    <input type="number" id="paAwal" placeholder="Saldo Awal">
                    <input type="number" id="paLimit" placeholder="Limit (opsional)">
                </div>
                <div class="btn-group">
                    <button id="paAdd" class="btn">Simpan Akun</button>
                    <button id="paDel" class="btn-subtle">Hapus Akun</button>
                </div>
            </div>
            <div class="card">
                <div class="flex-space">
                    <h3>Daftar Akun</h3>
                    <strong id="paTotal"></strong>
                </div>
                <div id="paList"></div>
            </div>
        </section>

    </main>

    <nav class="bottomnav">
        <a href="#" class="tab active" data-go="fisik">
            <span>üì¶</span>
            <div>Fisik</div>
        </a>
        <a href="#" class="tab" data-go="digital">
            <span>üì±</span>
            <div>Digital</div>
        </a>
        <a href="#" class="tab" data-go="stok">
            <span>üìù</span>
            <div>Stok</div>
        </a>
        <a href="#" class="tab" data-go="akun">
            <span>üë§</span>
            <div>Akun</div>
        </a>
    </nav>

<script>
// ========== DATABASE & STATE (using localStorage) ==========
const DB = {
  get: (key, fallback) => {
    const val = localStorage.getItem(key);
    if (val === null) return fallback;
    try { return JSON.parse(val); } catch (e) { return val; }
  },
  set: (key, val) => {
    localStorage.setItem(key, typeof val === 'object' ? JSON.stringify(val) : val);
  }
};

// ========== APP HELPERS & STATE ==========
const $ = (selector) => document.querySelector(selector);
const $$ = (selector) => document.querySelectorAll(selector);

const formatRupiah = (angka) => {
  return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(angka || 0);
};

const State = {
  akun: [],
  stok: [],
  transaksi: [],
  pengaturan: { theme: 'dark', font: '15' }
};

function loadState() {
  State.akun = DB.get('data_akun', []);
  State.stok = DB.get('data_stok', []);
  State.transaksi = DB.get('data_transaksi', []);
  State.pengaturan = DB.get('data_pengaturan', { theme: 'dark', font: '15' });
}

function saveState(key) {
  const keys = Array.isArray(key) ? key : [key];
  if (keys.includes('akun')) DB.set('data_akun', State.akun);
  if (keys.includes('stok')) DB.set('data_stok', State.stok);
  if (keys.includes('transaksi')) DB.set('data_transaksi', State.transaksi);
  if (keys.includes('pengaturan')) DB.set('data_pengaturan', State.pengaturan);
}

function updateBranding() {
  const nama = DB.get('profil_nama', 'Kasir Multi Saldo');
  const logoData = DB.get('profil_logo', null);
  const alamat = DB.get('profil_alamat', 'Alamat');
  const wa = DB.get('profil_wa', '');

  $("#headerTitle").textContent = nama;
  const logoBox = $("#logoBox");
  logoBox.innerHTML = logoData ? `<img src="${logoData}" class="logo" alt="logo">` : `<span>üßæ</span>`;

  $("#shopNameSide").textContent = nama;
  $("#shopAddrSide").textContent = alamat;
  const logoSide = $("#logoSide");
  if (logoData) {
    logoSide.src = logoData;
    logoSide.style.display = 'block';
    logoSide.parentElement.style.background = 'var(--card)';
  } else {
    logoSide.style.display = 'none';
    logoSide.parentElement.style.background = 'var(--bg)';
  }
}

function showPage(pageId) {
  if (!pageId) return;
  $$("main > section").forEach(p => p.classList.add('hidden'));
  const targetPage = $('#page-' + pageId);
  if (targetPage) targetPage.classList.remove('hidden');

  $$('.bottomnav .tab').forEach(tab => {
    tab.classList.toggle('active', tab.dataset.go === pageId);
  });
  $('#drawer').classList.remove('open');
}

function getTodayDate() {
    const today = new Date();
    const yyyy = today.getFullYear();
    const mm = String(today.getMonth() + 1).padStart(2, '0');
    const dd = String(today.getDate()).padStart(2, '0');
    return `${yyyy}-${mm}-${dd}`;
}

// ========== INITIALIZATION ==========
document.addEventListener('DOMContentLoaded', () => {

  // --- DEFINE ELEMENTS ---
  const pName = $('#pName'), pWa = $('#pWa'), pAddr = $('#pAddr'), pLogo = $('#pLogo'), pSave = $('#pSave'), pClear = $('#pClear');
  const uTheme = $('#uTheme'), uFont = $('#uFont'), uSave = $('#uSave');
  const bgFile = $('#bgFile'), bgSave = $('#bgSave'), bgClear = $('#bgClear');
  const paName = $('#paName'), paAwal = $('#paAwal'), paLimit = $('#paLimit'), paAdd = $('#paAdd'), paDel = $('#paDel'), paList = $('#paList'), paTotal = $('#paTotal');
  const tKode = $('#tKode'), tNama = $('#tNama'), tBeli = $('#tBeli'), tJual = $('#tJual'), tQty = $('#tQty'), tAdd = $('#tAdd'), tDel = $('#tDel'), tList = $('#tList');
  let currentItem = null;
  const fKode = $('#fKode'), fNama = $('#fNama'), fBeli = $('#fBeli'), fJual = $('#fJual'), fQty = $('#fQty'), fModal = $('#fModal'), fOmzet = $('#fOmzet'), fLaba = $('#fLaba'), fAkun = $('#fAkun'), fJenis = $('#fJenis'), fDate = $('#fDate'), fBtnAuto = $('#fBtnAuto'), fSave = $('#fSave'), fClear = $('#fClear');
  const dJenis = $('#dJenis'), dDesc = $('#dDesc'), dBeli = $('#dBeli'), dJual = $('#dJual'), dLaba = $('#dLaba'), dPokok = $('#dPokok'), dFee = $('#dFee'), dAkun = $('#dAkun'), dDate = $('#dDate'), dSave = $('#dSave'), dClear = $('#dClear'), dModeJualBeli = $('#dModeJualBeli'), dModeTarik = $('#dModeTarik');
  const hScope = $('#hScope'), hFrom = $('#hFrom'), hTo = $('#hTo'), hAkun = $('#hAkun'), hSearch = $('#hSearch'), hClear = $('#hClear'), hResult = $('#hResult');
  const rDate = $('#rDate'), rAkun = $('#rAkun'), rkSeg = $('#rkSeg'), rkTitle = $('#rkTitle'), rkBody = $('#rkBody');

  // --- LOGIC & RENDER FUNCTIONS ---
  function updateAkunDropdowns() {
    const dropdowns = $$('#fAkun, #dAkun, #hAkun, #rAkun, #ioAkun');
    let accountOptions = '<option value="semua">Semua Akun</option>' + State.akun.map(akun => `<option value="${akun.nama}">${akun.nama}</option>`).join('');
    if(State.akun.length === 0) accountOptions = '<option>Buat akun dulu</option>';
    dropdowns.forEach(dd => {
      const currentValue = dd.value;
      dd.innerHTML = accountOptions;
      if (currentValue && (currentValue === 'semua' || State.akun.some(a => a.nama === currentValue))) dd.value = currentValue;
    });
  }

  function renderAkunList() {
    paList.innerHTML = '';
    if (State.akun.length === 0) {
      paList.innerHTML = '<div class="sub">Belum ada akun.</div>';
      paTotal.textContent = 'Total: Rp 0';
      updateAkunDropdowns();
      return;
    }
    const table = document.createElement('table');
    table.className = 'table';
    table.innerHTML = `<thead><tr><th>Nama Akun</th><th>Saldo</th><th>Limit</th></tr></thead><tbody></tbody>`;
    const tbody = table.querySelector('tbody');
    let totalSaldo = 0;
    State.akun.forEach(akun => {
      const tr = document.createElement('tr');
      tr.style.cursor = 'pointer';
      tr.dataset.nama = akun.nama;
      tr.innerHTML = `<td>${akun.nama}</td><td>${formatRupiah(akun.saldo)}</td><td>${formatRupiah(akun.limit)}</td>`;
      tbody.appendChild(tr);
      totalSaldo += (akun.saldo || 0);
    });
    paList.appendChild(table);
    paTotal.textContent = `Total: ${formatRupiah(totalSaldo)}`;
    updateAkunDropdowns();
  }

  function applyBackground() {
      const bgData = DB.get('app_background', null);
      document.body.style.backgroundImage = bgData ? `url(${bgData})` : 'none';
      if(bgData) {
        document.body.style.backgroundSize = 'cover';
        document.body.style.backgroundPosition = 'center';
        document.body.style.backgroundAttachment = 'fixed';
      }
  }

  function applyPengaturan() {
    const theme = State.pengaturan.theme;
    document.documentElement.dataset.theme = theme === 'auto' ? (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light') : theme;
    document.body.style.fontSize = State.pengaturan.font + 'px';
  }

  function loadPengaturanForm() {
    uTheme.value = State.pengaturan.theme;
    uFont.value = State.pengaturan.font;
  }

  function loadProfileSettings() {
    pName.value = DB.get('profil_nama', '');
    pWa.value = DB.get('profil_wa', '');
    pAddr.value = DB.get('profil_alamat', '');
  };

  // --- EVENT LISTENERS ---
  $('.bottomnav').addEventListener('click', (e) => { const t = e.target.closest('a.tab'); if(t && t.dataset.go) { e.preventDefault(); showPage(t.dataset.go); } });
  $('#btnMenu').addEventListener('click', () => $('#drawer').classList.add('open'));
  $('#closeDrawer').addEventListener('click', () => $('#drawer').classList.remove('open'));
  $('#mask').addEventListener('click', () => $('#drawer').classList.remove('open'));
  $('#drawer .menu').addEventListener('click', (e) => { const t = e.target.closest('a'); if(t && t.dataset.go) { e.preventDefault(); showPage(t.dataset.go); } });

  pSave.addEventListener('click', () => {
    DB.set('profil_nama', pName.value); DB.set('profil_wa', pWa.value); DB.set('profil_alamat', pAddr.value);
    const file = pLogo.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = (e) => { DB.set('profil_logo', e.target.result); updateBranding(); alert('Profil berhasil disimpan!'); };
      reader.readAsDataURL(file);
    } else { updateBranding(); alert('Profil berhasil disimpan!'); }
  });
  pClear.addEventListener('click', () => {
    if (!confirm('Anda yakin?')) return;
    pName.value = ''; pWa.value = ''; pAddr.value = ''; pLogo.value = '';
    ['profil_nama', 'profil_wa', 'profil_alamat', 'profil_logo'].forEach(k => localStorage.removeItem(k));
    updateBranding(); alert('Profil dikosongkan.');
  });

  uSave.addEventListener('click', () => {
    State.pengaturan.theme = uTheme.value; State.pengaturan.font = uFont.value;
    saveState('pengaturan'); applyPengaturan(); alert('Pengaturan user disimpan!');
  });
  bgSave.addEventListener('click', () => {
      const file = bgFile.files[0]; if (!file) { alert('Pilih file gambar.'); return; }
      if (file.size > 2 * 1024 * 1024) { alert('Ukuran gambar maks 2MB.'); return; }
      const reader = new FileReader();
      reader.onload = (e) => { DB.set('app_background', e.target.result); applyBackground(); alert('Background disimpan!'); };
      reader.readAsDataURL(file);
  });
  bgClear.addEventListener('click', () => {
      if (confirm('Hapus background?')) { localStorage.removeItem('app_background'); applyBackground(); bgFile.value = ''; }
  });

  paAdd.addEventListener('click', () => {
    const nama = paName.value.trim(); const saldo = parseInt(paAwal.value) || 0; const limit = parseInt(paLimit.value) || 0;
    if (!nama) { alert('Nama akun tidak boleh kosong.'); return; }
    const existingIdx = State.akun.findIndex(a => a.nama.toLowerCase() === nama.toLowerCase());
    if (existingIdx > -1) { State.akun[existingIdx].saldo = saldo; State.akun[existingIdx].limit = limit; }
    else { State.akun.push({ nama, saldo, limit }); }
    saveState('akun'); renderAkunList(); paName.value = ''; paAwal.value = ''; paLimit.value = '';
  });
  paDel.addEventListener('click', () => {
    const nama = paName.value.trim(); if (!nama) { alert('Isi nama akun.'); return; }
    const initialLength = State.akun.length;
    State.akun = State.akun.filter(a => a.nama.toLowerCase() !== nama.toLowerCase());
    if (State.akun.length === initialLength) { alert(`Akun "${nama}" tidak ditemukan.`); }
    else { saveState('akun'); renderAkunList(); paName.value = ''; paAwal.value = ''; paLimit.value = ''; }
  });
  paList.addEventListener('click', (e) => {
    const row = e.target.closest('tr'); if (!row) return;
    const akun = State.akun.find(a => a.nama === row.dataset.nama);
    if (akun) { paName.value = akun.nama; paAwal.value = akun.saldo; paLimit.value = akun.limit || ''; }
  });

  // Stock & Physical Tx functions
  function renderStokList() {
    tList.innerHTML = '';
    if (State.stok.length === 0) {
      tList.innerHTML = '<div class="sub">Belum ada barang di stok.</div>';
      updateStokDropdown();
      return;
    }
    const table = document.createElement('table');
    table.className = 'table';
    table.innerHTML = `<thead><tr><th>Kode</th><th>Nama</th><th>H. Beli</th><th>H. Jual</th><th>Stok</th></tr></thead><tbody></tbody>`;
    const tbody = table.querySelector('tbody');
    State.stok.forEach(item => {
        const tr = document.createElement('tr');
        tr.style.cursor = 'pointer';
        tr.dataset.kode = item.kode;
        tr.innerHTML = `<td>${item.kode}</td><td>${item.nama}</td><td>${formatRupiah(item.beli)}</td><td>${formatRupiah(item.jual)}</td><td>${item.qty}</td>`;
        tbody.appendChild(tr);
    });
    tList.appendChild(table);
    updateStokDropdown();
  }

  function updateStokDropdown() {
      const datalist = $('#listBarang');
      datalist.innerHTML = '';
      State.stok.forEach(item => {
          const option = document.createElement('option');
          option.value = item.kode;
          option.textContent = `${item.nama} (Stok: ${item.qty})`;
          datalist.appendChild(option);
      });
  }

  function findAndFillItem() {
      const kode = fKode.value.trim().toUpperCase();
      if (!kode) return;
      const item = State.stok.find(s => s.kode === kode);
      if (item) {
          currentItem = item;
          fNama.value = item.nama;
          fBeli.value = item.beli;
          fJual.value = item.jual;
          fQty.focus();
      } else {
          currentItem = null;
          fNama.value = '';
          fBeli.value = '';
          fJual.value = '';
          alert('Barang tidak ditemukan di stok.');
      }
      updateFisikStats();
  }

  function updateFisikStats() {
      const qty = parseInt(fQty.value) || 0, beli = parseInt(fBeli.value) || 0, jual = parseInt(fJual.value) || 0;
      const modal = beli * qty, omzet = jual * qty, laba = omzet - modal;
      fModal.textContent = formatRupiah(modal);
      fOmzet.textContent = formatRupiah(omzet);
      fLaba.textContent = formatRupiah(laba);
  }

  function clearFisikForm() {
      currentItem = null; fKode.value = ''; fNama.value = ''; fBeli.value = ''; fJual.value = '';
      fQty.value = '1'; fJenis.value = 'jual'; fDate.value = getTodayDate();
      updateFisikStats(); fKode.focus();
  }

  // Stock & Physical Tx listeners
  tAdd.addEventListener('click', () => {
      const kode = tKode.value.trim().toUpperCase(), nama = tNama.value.trim(), beli = parseInt(tBeli.value) || 0, jual = parseInt(tJual.value) || 0, qty = parseInt(tQty.value) || 0;
      if (!kode || !nama) { alert('Kode dan Nama barang tidak boleh kosong.'); return; }
      const existingIdx = State.stok.findIndex(s => s.kode === kode);
      if (existingIdx > -1) {
          const item = State.stok[existingIdx]; item.nama = nama; item.beli = beli; item.jual = jual;
          if (qty > 0) item.qty += qty;
          alert(`Stok untuk "${kode}" berhasil diupdate.`);
      } else {
          if (qty <= 0) { alert('Stok awal harus lebih dari 0 untuk barang baru.'); return; }
          State.stok.push({ kode, nama, beli, jual, qty });
          alert(`Barang baru "${kode}" berhasil ditambahkan.`);
      }
      saveState('stok'); renderStokList(); tKode.value = ''; tNama.value = ''; tBeli.value = ''; tJual.value = ''; tQty.value = ''; tQty.placeholder = 'Stok Awal / Tambah';
  });
  tDel.addEventListener('click', () => {
      const kode = tKode.value.trim().toUpperCase(); if (!kode) { alert('Isi kode barang yang ingin dihapus.'); return; }
      if (!confirm(`Yakin ingin hapus barang "${kode}"?`)) return;
      const initialLength = State.stok.length; State.stok = State.stok.filter(s => s.kode !== kode);
      if (State.stok.length === initialLength) { alert(`Barang dengan kode "${kode}" tidak ditemukan.`); }
      else { saveState('stok'); renderStokList(); tKode.value = ''; tNama.value = ''; tBeli.value = ''; tJual.value = ''; tQty.value = ''; tQty.placeholder = 'Stok Awal / Tambah'; alert(`Barang "${kode}" berhasil dihapus.`); }
  });
  tList.addEventListener('click', (e) => {
      const row = e.target.closest('tr'); if (!row) return;
      const item = State.stok.find(s => s.kode === row.dataset.kode);
      if (item) { tKode.value = item.kode; tNama.value = item.nama; tBeli.value = item.beli; tJual.value = item.jual; tQty.value = ''; tQty.placeholder = `Stok ada: ${item.qty}. Isi untuk menambah.`; }
  });
  fKode.addEventListener('change', findAndFillItem);
  fBtnAuto.addEventListener('click', findAndFillItem);
  [fQty, fJual, fBeli].forEach(el => el.addEventListener('input', updateFisikStats));
  fClear.addEventListener('click', clearFisikForm);
  fSave.addEventListener('click', () => {
      if (!currentItem) { alert('Pilih barang dari stok (ketik kode lalu enter).'); return; }
      const akunName = fAkun.value; if (!akunName || State.akun.length === 0) { alert('Pilih akun saldo.'); return; }
      const qty = parseInt(fQty.value); if (!qty || qty <= 0) { alert('Kuantitas harus lebih dari 0.'); return; }
      const jenis = fJenis.value;
      const itemIndex = State.stok.findIndex(s => s.kode === currentItem.kode);
      const akunIndex = State.akun.findIndex(a => a.nama === akunName);
      if ((jenis === 'jual' || jenis === 'retur-beli') && State.stok[itemIndex].qty < qty) { alert(`Stok tidak cukup. Sisa stok: ${State.stok[itemIndex].qty}`); return; }
      const beli = parseInt(fBeli.value), jual = parseInt(fJual.value), modal = beli * qty, omzet = jual * qty;
      let saldoChange = 0;
      if (jenis === 'jual') { State.stok[itemIndex].qty -= qty; saldoChange = omzet; }
      else if (jenis === 'beli') { State.stok[itemIndex].qty += qty; saldoChange = -modal; }
      else if (jenis === 'retur-jual') { State.stok[itemIndex].qty += qty; saldoChange = -omzet; }
      else if (jenis === 'retur-beli') { State.stok[itemIndex].qty -= qty; saldoChange = modal; }
      State.akun[akunIndex].saldo += saldoChange;
      State.transaksi.unshift({ id: 'trx' + Date.now(), tanggal: fDate.value, jenis: 'fisik', tipe: jenis, kode: currentItem.kode, nama: currentItem.nama, qty: qty, hargaBeli: beli, hargaJual: jual, laba: omzet - modal, total: jenis.startsWith('beli') ? -modal : omzet, akun: akunName });
      saveState(['stok', 'akun', 'transaksi']);
      alert('Transaksi berhasil disimpan!'); renderStokList(); renderAkunList(); clearFisikForm();
  });

  function handleDigitalModeChange() {
      const mode = dJenis.value;
      dModeJualBeli.classList.toggle('hidden', mode === 'tarik');
      dModeTarik.classList.toggle('hidden', mode !== 'tarik');
  }

  function updateDigitalLaba() {
      dLaba.textContent = formatRupiah((parseInt(dJual.value) || 0) - (parseInt(dBeli.value) || 0));
  }

  function clearDigitalForm() {
      dJenis.value = 'jual'; dBeli.value = '0'; dJual.value = '0'; dPokok.value = '0';
      dFee.value = '0'; dDesc.value = ''; dDate.value = getTodayDate();
      updateDigitalLaba(); handleDigitalModeChange();
  }

  function renderHistory() {
      const scope = hScope.value, from = hFrom.value, to = hTo.value, akun = hAkun.value, search = hSearch.value.toLowerCase();
      let fromDate = new Date('1970-01-01'), toDate = new Date('2999-12-31');
      if (scope === 'day') { fromDate = new Date(to); }
      else if (scope === 'month') { const d = new Date(to); fromDate = new Date(d.getFullYear(), d.getMonth(), 1); }
      else if (scope === 'custom' && from) { fromDate = new Date(from); }
      toDate = new Date(to);
      toDate.setHours(23, 59, 59, 999);

      const filtered = State.transaksi.filter(t => {
          const tDate = new Date(t.tanggal);
          const inDate = tDate >= fromDate && tDate <= toDate;
          const inAkun = akun === 'semua' || t.akun === akun;
          const inSearch = !search || JSON.stringify(t).toLowerCase().includes(search);
          return inDate && inAkun && inSearch;
      });

      hResult.innerHTML = '';
      if (filtered.length === 0) { hResult.innerHTML = '<div>Tidak ada transaksi.</div>'; return; }
      let totalLaba = 0, totalMasuk = 0, totalKeluar = 0;
      filtered.forEach(t => {
          const div = document.createElement('div');
          div.className = 'trx-item';
          let title = '', detail = '', amount = '';
          if (t.jenis === 'fisik') {
              title = `[${t.tipe.toUpperCase()}] ${t.nama} (${t.qty})`;
              detail = `Modal ${formatRupiah(t.hargaBeli*t.qty)}, Jual ${formatRupiah(t.hargaJual*t.qty)}`;
              if(t.laba) totalLaba += t.laba;
          } else {
              title = `[${t.tipe.toUpperCase()}] ${t.deskripsi}`;
              detail = t.tipe === 'tarik' ? `Pokok ${formatRupiah(t.detail.pokok)}, Fee ${formatRupiah(t.detail.fee)}` : `Beli ${formatRupiah(t.detail.hargaBeli)}, Jual ${formatRupiah(t.detail.hargaJual)}`;
              if(t.laba) totalLaba += t.laba;
          }
          amount = `<div class="${t.total > 0 ? 'in' : 'out'}">${formatRupiah(t.total)}</div>`;
          if (t.total > 0) totalMasuk += t.total; else totalKeluar += t.total;
          div.innerHTML = `<div><div class="trx-title">${title}</div><div class="trx-detail">${t.tanggal} ‚Ä¢ ${t.akun} ‚Ä¢ ${detail}</div></div>${amount}`;
          hResult.appendChild(div);
      });
      const summary = document.createElement('div');
      summary.className = 'trx-summary';
      summary.innerHTML = `<div>Masuk: <span class="in">${formatRupiah(totalMasuk)}</span></div> <div>Keluar: <span class="out">${formatRupiah(totalKeluar)}</span></div> <div>Laba: <span>${formatRupiah(totalLaba)}</span></div>`;
      hResult.prepend(summary);
  }

  function initHistoryPage() {
      hTo.value = getTodayDate(); hFrom.style.display = 'none'; hAkun.value = 'semua';
      hScope.addEventListener('change', () => { hFrom.style.display = hScope.value === 'custom' ? 'block' : 'none'; renderHistory(); });
      [hAkun, hFrom, hTo, hSearch].forEach(el => el.addEventListener('input', renderHistory));
      hClear.addEventListener('click', () => { hScope.value = 'month'; hTo.value = getTodayDate(); hFrom.value = ''; hAkun.value = 'semua'; hSearch.value = ''; hFrom.style.display = 'none'; renderHistory(); });
      new MutationObserver((mutations) => { if (!mutations[0].target.classList.contains('hidden')) renderHistory(); }).observe($('#page-history'), { attributes: true });
  }

  function renderRekap() {
      const date = new Date(rDate.value);
      const akun = rAkun.value;
      const mode = rkSeg.querySelector('.on').dataset.mode;
      let trx = State.transaksi;
      if (akun !== 'semua') trx = trx.filter(t => t.akun === akun);
      let title = `Rekap ${mode.charAt(0).toUpperCase() + mode.slice(1)} - ${akun.toUpperCase()} - `;
      let grouped = {};

      if (mode === 'harian') {
          const dateStr = date.toISOString().split('T')[0];
          trx = trx.filter(t => t.tanggal === dateStr);
          title += dateStr;
          grouped = trx.reduce((acc, t) => {
              const key = t.jenis === 'fisik' ? `[${t.tipe}] ${t.nama}` : `[${t.tipe}] ${t.deskripsi}`;
              if (!acc[key]) acc[key] = { qty: 0, total: 0, laba: 0 };
              acc[key].qty += t.qty || 1;
              acc[key].total += t.total;
              acc[key].laba += t.laba;
              return acc;
          }, {});
      } else { // bulanan
          const year = date.getFullYear();
          const month = date.getMonth();
          title += `${year}-${String(month + 1).padStart(2, '0')}`;
          trx = trx.filter(t => { const d = new Date(t.tanggal); return d.getFullYear() === year && d.getMonth() === month; });
          grouped = trx.reduce((acc, t) => {
              const key = t.tanggal;
              if (!acc[key]) acc[key] = { qty: 0, total: 0, laba: 0 };
              acc[key].qty += t.qty || 1;
              acc[key].total += t.total;
              acc[key].laba += t.laba;
              return acc;
          }, {});
      }

      rkTitle.textContent = title;
      rkBody.innerHTML = '';
      if (Object.keys(grouped).length === 0) { rkBody.innerHTML = 'Tidak ada data.'; return; }
      const table = document.createElement('table');
      table.className = 'table';
      table.innerHTML = `<thead><tr><th>${mode === 'harian' ? 'Item' : 'Tanggal'}</th><th>Qty</th><th>Total</th><th>Laba</th></tr></thead><tbody></tbody>`;
      const tbody = table.querySelector('tbody');
      let grandTotal = 0, grandLaba = 0;
      for (const key in grouped) {
          const item = grouped[key];
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${key}</td><td>${item.qty}</td><td>${formatRupiah(item.total)}</td><td>${formatRupiah(item.laba)}</td>`;
          tbody.appendChild(tr);
          grandTotal += item.total;
          grandLaba += item.laba;
      }
      const tfoot = document.createElement('tfoot');
      tfoot.innerHTML = `<tr><th>Total</th><th></th><th>${formatRupiah(grandTotal)}</th><th>${formatRupiah(grandLaba)}</th></tr>`;
      table.appendChild(tfoot);
      rkBody.appendChild(table);
  }

  function initRekapPage() {
      rDate.value = getTodayDate(); rAkun.value = 'semua';
      [rDate, rAkun].forEach(el => el.addEventListener('input', renderRekap));
      rkSeg.addEventListener('click', (e) => {
          if (e.target.tagName === 'BUTTON') {
              rkSeg.querySelector('.on').classList.remove('on');
              e.target.classList.add('on');
              renderRekap();
          }
      });
      new MutationObserver((mutations) => { if (!mutations[0].target.classList.contains('hidden')) { updateBranding(); renderRekap(); } }).observe($('#page-rekap'), { attributes: true });
  }

  dJenis.addEventListener('change', handleDigitalModeChange);
  [dBeli, dJual].forEach(el => el.addEventListener('input', updateDigitalLaba));
  dClear.addEventListener('click', clearDigitalForm);
  dSave.addEventListener('click', () => {
      const akunName = dAkun.value, jenis = dJenis.value, desc = dDesc.value.trim();
      if (!akunName || State.akun.length === 0) { alert('Pilih akun saldo.'); return; }
      if (!desc) { alert('Deskripsi tidak boleh kosong.'); return; }
      const akunIndex = State.akun.findIndex(a => a.nama === akunName);
      let saldoChange = 0, laba = 0, total = 0, detail = {};
      if (jenis === 'jual' || jenis === 'beli') {
          const beli = parseInt(dBeli.value) || 0, jual = parseInt(dJual.value) || 0;
          if (jual <= 0 && jenis === 'jual') { alert('Harga Jual harus lebih dari 0.'); return; }
          if (beli <= 0 && jenis === 'beli') { alert('Harga Beli harus lebih dari 0.'); return; }
          laba = jual - beli; saldoChange = (jenis === 'jual') ? jual : -beli; total = saldoChange;
          detail = { hargaBeli: beli, hargaJual: jual };
      } else {
          const pokok = parseInt(dPokok.value) || 0, fee = parseInt(dFee.value) || 0;
          if (pokok <= 0) { alert('Jumlah Pokok harus lebih dari 0.'); return; }
          laba = fee; saldoChange = -(pokok + fee); total = saldoChange;
          detail = { pokok: pokok, fee: fee };
      }
      State.akun[akunIndex].saldo += saldoChange;
      State.transaksi.unshift({ id: 'trx' + Date.now(), tanggal: dDate.value, jenis: 'digital', tipe: jenis, deskripsi: desc, laba: laba, total: total, akun: akunName, detail: detail });
      saveState(['akun', 'transaksi']);
      alert('Transaksi digital berhasil disimpan!'); renderAkunList(); clearDigitalForm();
  });

  // --- INITIAL LOAD & EXECUTION ---
  loadState();
  applyBackground();
  updateBranding();
  loadProfileSettings();
  loadPengaturanForm();
  applyPengaturan();
  renderAkunList();
  renderStokList();
  clearFisikForm();
  clearDigitalForm();
  initHistoryPage();
  initRekapPage();
  showPage('fisik');
});
</script>
</body>
</html>
